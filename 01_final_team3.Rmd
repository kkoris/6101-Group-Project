---
title: "01_final"
author: "Team3"
date: "`r Sys.Date()`"
output: 
  html_document:
    code_folding: hide
    number_sections: false
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '3'
---

```{r init, include=FALSE}
# some of common options (and the defaults) are: 
# include=T, eval=T, echo=T, results='hide'/'asis'/'markup',..., collapse=F, warning=T, message=T, error=T, cache=T, fig.width=6, fig.height=4, fig.dim=c(6,4) #inches, fig.align='left'/'center','right', 
library(ezids)
# knitr::opts_chunk$set(warning = F, results = "markup", message = F)
knitr::opts_chunk$set(warning = F, results = "hide", message = F)
options(scientific=T, digits = 3) 
# options(scipen=9, digits = 3) 
# ‘scipen’: integer. A penalty to be applied when deciding to print numeric values in fixed or exponential notation.  Positive values bias towards fixed and negative towards scientific notation: fixed notation will be preferred unless it is more than ‘scipen’ digits wider.
# use scipen=999 to prevent scientific notation at all times
```

## R Markdown 

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

# Team Project - COVID Data

### Research Question: Do mentally unhealthy days, race(Black), education, housing and smoking status have a statistically significant impact on number of total COVID cases in population?  

In this study, the dependent variable (Totcaspopn) is the number of total cases per population and the independent variables are mental health days, race (black), colelge education, crowded housing, and smokers. Our research question explores whether number of mental health days, race (black), college education, crowded housing, and smoking has a statistically significant impact on the number of total COVID cases in a population? 

Below is a detailed list of the variables used: 

Variable |  Definition  
  :-:    |  :-- 
TotalCases | Total Cases of COVID-19 infections
Population | percentage of people living in that county (for demographic %)
Blacks| percentage of Black people who have contracted COVID-19
College Education | number of people who have a College Education in the region
HseCrowded | Housing Overcrowding (multiple people in the house)
Menunhlthdays | average number of mentally unhealthy days
Smokers | percentage of Smokers
Totcaspopn | Total population over proportion *(need to fact check this)

## Imported data

```{r import,results='markup'}

Counties_Dataset <- read.csv("Counties Dataset.csv")

```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.



## Data cleaning

Removing characters from data frame.   

```{r, results='markup'}
new_Coundf<-Counties_Dataset[, !sapply(Counties_Dataset, is.character)]
```

Dropping data frame columns.   

```{r, results='markup'}

new_df <- new_Coundf[ , -c(1,2,6,7,19,22,23,24,26,27,29,30,31,32,33,34,41,45,46,48,49) ]

new_df1<-new_df[, -c(16,20,21,22,23,27,28,31,32,33,34,35 )]

new_clean<-new_df1[, -c(10,11,12)]


```

Changing data frame column names.  

```{r, results='markup'}
colnames(new_clean)<- c("Totalcases","Deaths","Population", "Blacks","Natives","Asians","Hispanics","White","PDSqmile","HDSqmile","ColEduc","Socialize","HseCrowded","Diabetic","PoorHlth","Menunhlthdays","Smokers","Fluvax","RespDisease")
```

Removing NAs from the data frame.   

```{r, results='markup'}
clean<- na.omit(new_clean) 
```

## Creating a new Y variable

The Y variable or dependent variable is total cases per population. 

```{r}
clean$Totcaspopn<-clean$Totalcases/clean$Population
#print(clean)
```

## Created subset of data for independent variables

```{r}
finalclean<-clean[, -c(2, 5, 6, 7, 8, 9, 10, 12, 14, 15, 18, 19, 20)]
```

Remaining variables in the new data frame are Totcaspopn+ Menunhlthdays + Blacks + ColEduc + Smokers + hsecrowded +total cases + population. 

## Descriptive Statistics

```{r, results='markup'}
library(ezids)
xkablesummary(finalclean, title = "Summary of Data")
```


##Exploratory Data Analysis
## Testing for Normality and Distribution of Variables


```{r, results='markup'}
library(ggpubr)
ggdensity(finalclean$Totcaspopn, main = "Density plot of Total Cases Per Population", xlab = "Total Cases Per Population")
ggdensity(finalclean$Population, main = "Density plot of Population", xlab = "Population")
ggdensity(finalclean$Blacks, main = "Density plot of Black People", xlab = "Population of Black People")
ggdensity(finalclean$ColEduc, main = "Density plot of People with College Education", xlab = "College Education")
ggdensity(finalclean$HseCrowded, main = "Density plot of Crowded Housing", xlab = "Crowded Housing")
ggdensity(finalclean$Menunhlthdays, main = "Density plot of Mental Unhealthy Days", xlab = "Mental Unhealthy Days")
ggdensity(finalclean$Smokers, main = "Density plot of Smokers", xlab = "Smokers")
library(ggplot2)
ggplot(finalclean, aes(x=finalclean$Totalcases)) + geom_density(alpha=0.3)
ggplot(finalclean, aes(x=Totcaspopn)) + geom_histogram(fill="steelblue", color="black") + ggtitle("Histogram of Total Cases per Population")
ggplot(finalclean, aes(x=Population)) + geom_histogram(fill="steelblue", color="black") + ggtitle("Histogram of Population")
ggplot(finalclean, aes(x=Blacks)) + geom_histogram(fill="steelblue", color="black") + ggtitle("Histogram of Black")
ggplot(finalclean, aes(x=ColEduc)) + geom_histogram(fill="steelblue", color="black") + ggtitle("Histogram of College Education")
ggplot(finalclean, aes(x=HseCrowded)) + geom_histogram(fill="steelblue", color="black") + ggtitle("Histogram of Crowded Housing")
ggplot(finalclean, aes(x=Menunhlthdays)) + geom_histogram(fill="steelblue", color="black") + ggtitle("Histogram of Mental Health Days")
ggplot(finalclean, aes(x=finalclean$Smokers)) + geom_histogram(fill="steelblue", color="black") + ggtitle("Histogram of Smokers")
plot(finalclean$Population)
plot(finalclean$Totalcases)
plot(finalclean$Blacks)
plot(finalclean$ColEduc)
plot(finalclean$HseCrowded)
plot(finalclean$Menunhlthdays)
plot(finalclean$Smokers)
plot(finalclean$Totcaspopn)
plot(finalclean)

```

## QQ Plots- Testing for Normality 

```{r, results='markup'}
#qqplot(finalclean$Totcaspopn, finalclean$Population, main = "QQ Plot of Total cases Per Population", xlab = "County Population")

#create Q-Q plot
qqnorm(finalclean$Totcaspopn,  main = "QQ Plot of Total cases Per Population")
qqline(finalclean$Totcaspopn)
qqnorm(finalclean$Population,  main = "QQ Plot of  Population")
qqline(finalclean$Population)
qqnorm(finalclean$Menunhlthdays, main = "QQ Plot of Mental Unhealthy Day")
qqline(finalclean$Menunhlthdays)
qqnorm(finalclean$Blacks, main = "QQ Plot of the Black Population")
qqline(finalclean$Blacks)
qqnorm(finalclean$HseCrowded, main = "QQ Plot of the Crowded Housing")
qqline(finalclean$HseCrowded)
qqnorm(finalclean$Smokers, main = "QQ Plot of the Smokers")
qqline(finalclean$Smokers)
qqnorm(finalclean$ColEduc, main = "QQ Plot of the College Education")
qqline(finalclean$ColEduc)

```
##Removing outliers from `Population`, `Blacks`, and `College Education`. Using the `ezids::outlierKD2()` function to remove the outliers for `Population`, `Blacks`, and `College Education`

```{r, results='markup'}
library(ezids)
ClnData = outlierKD2(finalclean, Population, rm=TRUE, boxplt=TRUE, histogram=TRUE, qqplt=TRUE) 
```

```{r, results='markup'}
ClnData = outlierKD2(ClnData, Blacks, rm=TRUE, boxplt=TRUE, histogram=TRUE, qqplt=TRUE)
```

```{r, results='markup'}
ClnData = outlierKD2(ClnData, ColEduc, rm=TRUE, boxplt=TRUE, histogram=TRUE, qqplt=TRUE)

```
```{r, results='markup'}
ClnData = outlierKD2(ClnData, Totcaspopn, rm=TRUE, boxplt=TRUE, histogram=TRUE, qqplt=TRUE)
```


## QQ Plot after removing outliers

```{r}
qqnorm(ClnData$Population, main="Q-Q plot of Population with outlier removed") 
qqline(ClnData$Population)

qqnorm(ClnData$Blacks, main="Q-Q plot of Blacks with outlier removed") 
qqline(ClnData$Blacks)

qqnorm(ClnData$ColEduc, main="Q-Q plot of College Education with outlier removed") 
qqline(ClnData$ColEduc)

qqnorm(ClnData$Totcaspopn, main="Q-Q plot of College Education with outlier removed") 
qqline(ClnData$Totcaspopn)

```
##Histograms of all data after removing outliers

```{r, results='markup'}
library(ggplot2)
ggplot(ClnData, aes(x=Totcaspopn)) + geom_histogram(fill="steelblue", color="black") + ggtitle("Histogram of Total Cases per Population")
ggplot(ClnData, aes(x=Population)) + geom_histogram(fill="steelblue", color="black") + ggtitle("Histogram of Population")
ggplot(ClnData, aes(x=Blacks)) + geom_histogram(fill="steelblue", color="black") + ggtitle("Histogram of Black")
ggplot(ClnData, aes(x=ColEduc)) + geom_histogram(fill="steelblue", color="black") + ggtitle("Histogram of College Education")
ggplot(ClnData, aes(x=HseCrowded)) + geom_histogram(fill="steelblue", color="black") + ggtitle("Histogram of Crowded Housing")
ggplot(ClnData, aes(x=Menunhlthdays)) + geom_histogram(fill="steelblue", color="black") + ggtitle("Histogram of Mental Health Days")
ggplot(ClnData, aes(x=finalclean$Smokers)) + geom_histogram(fill="steelblue", color="black") + ggtitle("Histogram of Smokers")
```

##Removing NAs from the new data frame without outliers

```{r, results='markup'}
AclnData<- na.omit(ClnData) 
```

### Creating a Correlation Matrix

Include these only Totcaspopn ~ Menunhlthdays + Blacks + Hispanics + Asians + White + PDSqmile + HDSqmile + ColEduc + Socialize + HseCrowded + Diabetic + PoorHlth + Smokers + Fluvax +RespDisease + Population. 

```{r, results='markup'}
corClean<-cor(as.matrix(AclnData))
corClean
```

## Correlation Matrix

```{r, results='markup'}
library(ezids)

xkabledply(corClean)

```

## Correlation Plot

```{r, results='markup'}
#install.packages("corrplot")
library(corrplot)
corrplot(corClean)
```


## Good Fit Model of Linear Regression

```{r}
library(MASS)
model <- lm(Totcaspopn ~ Population + Blacks +  Menunhlthdays + Smokers + ColEduc, AclnData)
stepAIC(model,direction = 'backward')
print('lm(formula = Totcaspopn ~ Population + Blacks +
     Menunhlthdays + Smokers, clean) is good fit model')
model1 <- lm(Totcaspopn ~ Population + Blacks + Menunhlthdays + Smokers + ColEduc, AclnData)
summary(model1)
model1$coefficients
xkabledply(confint(model1))
xkablevif(model1, title = "vif")
plot(model1)
```

### Check for Correlation Test (cor.test)

```{r}
cor.test(AclnData$Totcaspopn,as.numeric(AclnData$Population), method="pearson")
cor.test(AclnData$Totcaspopn,as.numeric(AclnData$Population), method="spearman")

cor.test(AclnData$Totcaspopn,as.numeric(AclnData$Menunhlthdays), method="pearson")
cor.test(AclnData$Totcaspopn,as.numeric(AclnData$Menunhlthdays), method="spearman")

```

##  T Test 

```{r}
t_test.ts80 = t.test(x=AclnData$Totcaspopn, conf.level=0.80)
t_test.ts80
t_test.ts80$conf.int
t_test.ts80$alternative
t_test.ts80$estimate
t_test.ts99 = t.test(x=AclnData$Totcaspopn, conf.level=0.99)
t_test.ts99
t_test.ts99$conf.int
t_test.ts99$alternative
t_test.ts99$estimate

```

# Model of Linear Regression  

### Feature selection

```{r}

loadPkg("leaps")
#This is essentially best fit 
reg.best10 <- regsubsets(Totcaspopn ~ Menunhlthdays + Blacks + ColEduc + HseCrowded + Smokers + Population, data = AclnData, nvmax = 15, nbest = 1, method = "exhaustive")  # leaps::regsubsets() - Model selection by exhaustive (default) search, forward or backward stepwise, or sequential replacement
#The plot will show the Adjust R^2 when using the variables across the bottom
plot(reg.best10, scale = "adjr2", main = "Exhaustive: Adjusted R^2")
plot(reg.best10, scale = "r2", main = "Exhaustive: R^2")
# In the "leaps" package, we can use scale=c("bic","Cp","adjr2","r2")
plot(reg.best10, scale = "bic", main = "Exhaustive: BIC")
plot(reg.best10, scale = "Cp", main = "Exhaustive: Cp")
summary(reg.best10)

```

## Linear Regression Model 

```{r, results='markup'}

Totcaspopn.lm <- lm(Totcaspopn ~ Menunhlthdays + Blacks + ColEduc + HseCrowded + Smokers + Population, data = AclnData)
summary(Totcaspopn.lm)

```


## VIF Check

```{r, results='markup'}
xkablevif(Totcaspopn.lm, title = "vif")
```


# Tree Model of Independent Variables

### Regression Tree #1

```{r, fig.dim=c(6,4)}
library(ezids)
loadPkg("rpart") # Classification trees, rpart(formula, data=, method=,control=) 
set.seed(1)
mentaltreefit <- rpart(Totcaspopn ~ Menunhlthdays + Blacks + ColEduc + HseCrowded + Smokers, data=AclnData, control = list(maxdepth = 50) )
printcp(mentaltreefit) # display the results 
# plotcp(mentaltreefit) # visualize cross-validation results 
summary(mentaltreefit) # detailed summary of splits
# plot tree 
plot(mentaltreefit, uniform=TRUE, main="Regression Tree")
text(mentaltreefit, use.n=TRUE, all=TRUE, cex=.75)
```

### Regression Tree #2

```{r fancyplot}
loadPkg("rpart.plot")
rpart.plot(mentaltreefit)
loadPkg("rattle") # For fancyRpartPlot (Trees) Answer "no" on installing from binary source
fancyRpartPlot(mentaltreefit)
```
```{r}
#define new player
new <- data.frame(ColEduc=16, Blacks=9, Menunhlthdays=10, Population=10000, HseCrowded=13,Smokers= 3)

#use pruned tree to predict salary of this player
predict(mentaltreefit, newdata = new)
```

